---
title: 'JAVA-锁 '
copyright: true
categories:
  - NoteBook
abbrlink: '13383729'
date: 2019-09-29 18:57:08
tags:
---

## 队列同步器

**AbstractQueuedSynchronizer：**用来构建锁或者其他同步组件的基础框架，使用一个int成员变量表示同步状态，通过内置的**FIFO双向队列**完成资源获取线程的排队工作，并发包作者希望它能成为实现大部分同步需求的基础。

同步器的设计是基于模板方法模式的，使用者需要继承同步器，并且重写指定的方法。

需要使用同步器提供的3个方法访问或者修改同步状态：

1. getState()或者当前同步状态
2. setState(int newState)设置当前同步状态
3. compareAndSetState(int expect,int uptate)使用cas设置当前同步状态，该方法能保证状态设置的原子性

**独占锁：**在同一时刻只能有一个线程获取锁，而其他获取锁的线程只能处于同步队列中排队，只有获取锁的线程释放了锁，后继的线程才能获取锁。

**共享锁：**与独占获取主要区别在于同一时刻是否有多个线程同时获取同步状态。

写操作要求对资源独占式访问，读操作可以是共享式访问。

**重入锁：**ReetrantLock，支持重进入的锁，支持一个线程对资源重复加速。除此之外还支持获取锁时的公平和非公平性选择。

​		**公平锁：**锁的获取顺序符合请求的绝对时间顺序，FIFO。

### 同步队列

同步器依赖内部的同步队列(FIFO双向队列)来完成同步状态的管理，当前线程获取同步状态失败时，同步器会将当前线程以及等待信息构造成一个节点Node并将其加入同步队列，同时阻塞当前线程，当同步状态释放时，会把首节点中的线程唤醒，使其再次尝试获取同步状态。

Node用来保存获取同步状态失败的线程引用、等待状态以及前后节点。

```
volatile int waitStatus; //等待状态SIGNAL:-1, CANCELLED:1， CONDITION:-1， PROPAGATE:-3，0:
volatile Node prev;
volatile Node next;
volatile Thread thread;获取同步状态的线程
Node nextWaiter;等待队列中的后继节点
     +------+  prev +-----+       +-----+
head |      | <---- |     | <---- |     |  tail
     +------+       +-----+       +-----+
```

![尾节点](2.jpg)

![自旋](3.jpg)